<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="dsc-cropper.html">

<dom-module id="dsc-polymer-image-upload">

  <template>

    <style>
      :host {

      }

      #container {
        width: 500px;
      }

      #upload-header {
        display: flex;
        align-items: center;
      }

      paper-button.indigo {
        background-color: var(--paper-indigo-500);
        color: white;
        --paper-button-raised-keyboard-focus: {
          background-color: var(--paper-pink-a200) !important;
          color: white !important;
        };
      }

      #label-qtd{
        margin-left: auto;
        padding-right: 7px;
      }

      .upload-item {
        /*position: relative;*/
        display: flex;
        align-items: center;

        box-sizing: border-box;
        min-width: 5.14em;
        margin: 0 0.29em;
        background: #ffffff;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        -webkit-tap-highlight-color: transparent;
        font: inherit;
        outline-width: 0;
        border-radius: 3px;
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        user-select: none;
        z-index: 0;
        padding: 0.7em 0.57em;
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
        margin-top: 10px;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                  0 1px 5px 0 rgba(0, 0, 0, 0.12),
                  0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      .upload-item img {
        width: 60px;
        height: 60px;
      }

      .text-container{
        padding-left: 10px;
      }

      .text-details {
        font-size: 10px;
        color: #666;
      }

      .text-description {
        font-size: 10px;
      }

      .icons-container{
        margin-left: auto;
      }
    </style>

    <div id="dsc-image-upoload">

      <input type="file" id="browse" hidden multiple on-change="_readFiles">

      <div id="preview"></div>

      <div id="upload-header">
        <paper-button raised class="indigo" on-click="_selectFiles">
          <iron-icon icon="icons:file-upload"></iron-icon>
          UPLOAD FILES
          </paper-button>
        <div id="label-qtd">2 of 10</div>
      </div>

      <div id="itens-container">

      </div>

      <paper-dialog id="dialog" modal>
        <div id="container"></div>
        <div class="buttons">
          <paper-button id="dialog-crop-confirm" raised><iron-icon icon="check"></iron-icon>Apply</paper-button>
          <paper-button dialog-confirm autofocus>Cancel</paper-button>
        </div>
      </paper-dialog>

    </div>
  </template>

  <script>
    Polymer({
      is: 'dsc-polymer-image-upload',

      properties: {

        /**
         * Maximum number of files.
         */
        maxFiles: {
          type: Number,
          default: 5,
        },

        /**
         * Max file size in bytes
         */
        maxFileSize: {
          type: Number,
          default: 5 * 1024, // 5MB
        },

        /**
         * Min image width in px.
         */
        minWidth: {
          type: Number,
          value: 320,
        },

        /**
         * Max image width in px.
         */
        maxWidth: {
          type: Number,
          value: 1920,
        },

        /**
         * Min image height in px.
         */
        minHeigth: {
          type: Number,
          value: 240,
        },

        /**
         * Max image height in px.
         */
        maxHeigth: {
          type: Number,
          value: 1080,
        },

        /**
         * Force aspect ratio. Ex: 16/9, 4/3, 1, 2/3 or 'Nan' for free.
         */
        aspectRatio: {
          type: Number,
          value: 16/9,
        },

        /**
         * Flag to image file parse.
         */
        useBlob: {
          type: Boolean,
        },

        /**
         * Cropper plugin object.
         * @see https://fengyuanchen.github.io/cropperjs/
         */
        dscCropper: {
          type: Object,
        },

        /**
         * Array of images object data and info. Ex:
         *  [
         *    {
         *      order: 1,
         *      src: "data:image/jpeg;base64,/9j/4AAQSkZJRgtgsrtgserfdhdfh...",
         *      width: 640,
         *      heigth: 480,
         *      size: 198542,
         *      name: 'teste.jpg',
         *      type: 'image/jpg',
         *      description: "Optional image description"
         *    },
         *    ...
         *  ]
         */
        items: {
          type: Array,
          value: [],
        }

      },

      _generateObjectId: function () {
        var timestamp = (new Date().getTime() / 1000 | 0).toString(16);
        return timestamp + 'xxxxxxxxxxxxxxxx'.replace(/[x]/g, function() {
            return (Math.random() * 16 | 0).toString(16);
        }).toLowerCase();
      },

      _selectFiles: function() {
        this.$.browse.value = '';
        this.$.browse.click();
      },

      _readFiles: function(e) {
        var that = this;
        // Let's store the FileList Array into a variable:
        // https://developer.mozilla.org/en-US/docs/Web/API/FileList
        //var files  = this.files;
        var files  = e.target.files;
        // Let's create an empty `errors` String to collect eventual errors into:
        var errors = "";
        if (! files) {
          errors += "File upload not supported by your browser.";
        }
        // Check for `files` (FileList) support and if contains at least one file:
        if (files && files[0]) {
          // Iterate over every File object in the FileList array
          for(var i=0; i<files.length; i++) {
            // Let's refer to the current File as a `file` variable
            // https://developer.mozilla.org/en-US/docs/Web/API/File
            var file = files[i];
            // Test the `file.name` for a valid image extension:
            // (pipe `|` delimit more image extensions)
            // The regex can also be expressed like: /\.(png|jpe?g|gif)$/i
            if ( (/\.(png|jpeg|jpg|gif)$/i).test(file.name) ) {
              // SUCCESS! It's an image!
              // Send our image `file` to our `_readImage` function!
              that._readImage(file);
            } else {
              errors += file.name +" Unsupported Image extension\n";
            }
          }
        }
        // Notify the user for any errors (i.e: try uploading a .txt file)
        if (errors) {
          alert(errors);
        }
      },

      _readImage: function(file) {
        var that = this;
        // Create a new FileReader instance
        // https://developer.mozilla.org/en/docs/Web/API/FileReader
        var reader = new FileReader();
        // Once a file is successfully readed:
        reader.addEventListener("load", function () {
          // At this point `reader.result` contains already the Base64 Data-URL
          // and we've could immediately show an image using
          // `elPreview.insertAdjacentHTML("beforeend", "<img src='"+ reader.result +"'>");`
          // But we want to get that image's width and height px values!
          // Since the File Object does not hold the size of an image
          // we need to create a new image and assign it's src, so when
          // the image is loaded we can calculate it's width and height:
          var image  = new Image();
          image.addEventListener("load", function () {
            var imgInfo = {
              name: file.name,
              width: image.width,
              height: image.height,
              type: file.type,
              size: file.size,
              src: image.src
            }
            // Finally append our created image and the HTML info string to our `#preview`
            //that.$.preview.appendChild(this);
            //that.$.preview.insertAdjacentHTML("beforeend", imageInfo +'<br>');
            that.addItem(this, imgInfo);
            // If we set the variable `useBlob` to true:
            // (Data-URLs can end up being really large
            // `src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAA...........etc`
            // Blobs are usually faster and the image src will hold a shorter blob name
            // src="blob:http%3A//example.com/2a303acf-c34c-4d0a-85d4-2136eef7d723"
            if (that.useBlob) {
              // Free some memory for optimal performance
              window.URL.revokeObjectURL(image.src);
            }
          });
          image.src = that.useBlob ? window.URL.createObjectURL(file) : reader.result;
          image.removeEventListener("load", function(){});
        });
        // https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsDataURL
        reader.readAsDataURL(file);
        reader.removeEventListener("load", function(){});

      },

      removeItem: function() {
        console.log('REMOVE ITEM');
      },

      addItem: function(img, imgInfo) {
        imgInfo.id = this._generateObjectId();
        this.items.push(
          imgInfo
        );

        var divItem = this.renderItem(img, imgInfo);
        this.$$('#itens-container').appendChild(divItem);
      },

      renderItem: function(img, imgInfo) {
        // div.upload-item
        var divItem = document.createElement('div');
        divItem.setAttribute('class', 'upload-item');
        divItem.setAttribute('id', 'item-' + imgInfo.id);
        // div.img-container
        var divImg = document.createElement('div');
        divImg.setAttribute('class', 'img-container');
        divImg.appendChild(img);
        // div.text-container
        var divText = document.createElement('div');
        divText.setAttribute('class', 'text-container');
        // name
        var divName = document.createElement('div');
        divName.innerText = imgInfo.name;
        divText.appendChild(divName);
        // details
        var divDetails = document.createElement('div');
        divDetails.setAttribute('class', 'text-details');
        divDetails.innerText = imgInfo.width + 'x' + imgInfo.height + ' (' + Math.round(imgInfo.size/1024) + 'KB' + ')';
        divText.appendChild(divDetails);
        // description
        if (typeof imgInfo.description != 'undefined') {
          divDescription = document.createElement('div');
          divDescription.setAttribute('class', 'text-description');
          divDescription.innerText = imgInfo.description;
          divText.appendChild(divDescription);
        }
        // div.icons-container
        var divIcons = document.createElement('div');
        divIcons.setAttribute('class', 'icons-container');
        // paper-icon-button (edit)
        var buttonEdit = document.createElement('paper-icon-button');
        buttonEdit.setAttribute('icon', 'icons:create');
        buttonEdit.setAttribute('title', 'Edit image');
        buttonEdit.setAttribute('class', 'teste');
        this.listen(buttonEdit, 'tap', '_openCropDialog');
        divIcons.appendChild(buttonEdit);
        // paper-icon-button (edit)
        var buttonRemove = document.createElement('paper-icon-button');
        buttonRemove.setAttribute('icon', 'icons:clear');
        buttonRemove.setAttribute('title', 'Edit image');
        this.listen(buttonRemove, 'tap', 'removeItem');
        divIcons.appendChild(buttonRemove);

        divItem.appendChild(divImg);
        divItem.appendChild(divText);
        divItem.appendChild(divIcons);

        return divItem;
      },

      validateItem: function(item) {

      },

      /**
       * On component ready.
       */
      ready: function() {
        window.URL = window.URL || window.webkitURL;
        this.useBlob = false && window.URL; // Set to `true` to use Blob instead of Data-URL
      },

      _onCropResult: function(e) {
        console.log('CROP');
        var item = e.detail;
        console.log(item);
        this._updateItem(item);
        this.$.dialog.close();
        // TODO: remove listeners
      },

      /**
       * Edit item
       */
      _openCropDialog: function(e) {
        var thisButton = e.currentTarget;
        var parent = thisButton.closest(".upload-item");
        var attrId = parent.getAttribute('id');
        var id = attrId.replace('item-', '');
        var item = this._getItemById(id);
        // open dialog
        this.$.dialog.open();
        this.dscCropper = document.createElement("dsc-cropper");
        this.dscCropper.id = item.id;
        this.dscCropper.type = item.type;
        this.dscCropper.name = item.name;
        this.dscCropper.description = item.description;
        this.dscCropper.src = item.src;
        this.dscCropper.aspectRatio = this.aspectRatio;
        this.dscCropper.minWidth = this.minWidth;
        this.dscCropper.maxWidth = this.aspectRamaxWidthtio;
        this.dscCropper.minHeigth = this.minHeigth;
        this.dscCropper.maxHeigth = this.maxHeigth;
        this.dscCropper.regions = this.officesRegions;
        this.dscCropper.cities = this.officesCities;
        this.listen(this.dscCropper, 'crop-result', '_onCropResult');
        this.listen(this.$$('#dialog-crop-confirm'), 'tap', 'crop');
        this.$.container.innerHTML = '';
        this.$.container.appendChild(this.dscCropper);
        Polymer.updateStyles();
      },

      /**
       * Dialog Aplly click
       */
      crop: function() {
        this.dscCropper.crop();
      },

      _getItemById: function(id) {
        for(var i = 0; i < this.items.length; i++) {
          if (this.items[i].id == id) {
            return this.items[i];
          }
        }
      },

      _updateItem: function(item) {
        // search item
        for(var i = 0; i < this.items.length; i++) {
          if (this.items[i].id == item.id) {
            // update object
            this.items[i].src = item.src;
            this.items[i].width = item.width;
            this.items[i].height = item.height;
            this.items[i].size = item.size;
            this.items[i].name = item.name;
            this.items[i].description = item.description;
            // update ui
            var currentUi = Polymer.dom(this.root).querySelector('#item-' + item.id);
            /*var img = Polymer.dom(currentUi).querySelector('img');
            img.src = item.src;
            var textDetail = Polymer.dom(currentUi).querySelector('.text-details');
            textDetail.innerText = item.width + 'x' + item.height + '(TODO: size)';*/
            var image  = new Image();
            image.src = item.src
            var divItem = this.renderItem(image, this.items[i]);
            currentUi.replaceWith(divItem);
          }
        }
      },
    });
  </script>

</dom-module>
